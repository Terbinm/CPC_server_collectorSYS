{% extends "base.html" %}

{% block title %}節點監控{% endblock %}
{% block page_title %}節點監控{% endblock %}

{% block content %}
<div class="sm:flex sm:items-center">
    <div class="sm:flex-auto">
        <p class="mt-2 text-sm text-gray-700">監控所有註冊分析節點的狀態與任務負載</p>
    </div>
</div>

<!-- 統計資訊 -->
<div class="mt-6 grid grid-cols-1 gap-5 sm:grid-cols-3">
    <div class="overflow-hidden rounded-lg bg-white shadow">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-server text-2xl text-gray-400"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">總節點數</dt>
                        <dd class="text-3xl font-semibold text-gray-900">{{ stats.total }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <div class="overflow-hidden rounded-lg bg-white shadow">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-circle text-2xl text-green-500"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">在線節點</dt>
                        <dd class="text-3xl font-semibold text-green-600">{{ stats.online }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <div class="overflow-hidden rounded-lg bg-white shadow">
        <div class="p-5">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-circle text-2xl text-red-500"></i>
                </div>
                <div class="ml-5 w-0 flex-1">
                    <dl>
                        <dt class="text-sm font-medium text-gray-500 truncate">離線節點</dt>
                        <dd class="text-3xl font-semibold text-red-600">{{ stats.offline }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 在線節點 -->
{% if online_nodes %}
<div class="mt-8">
    <h3 class="text-lg font-medium text-gray-900 mb-4">
        <i class="fas fa-circle text-green-500 mr-2"></i>
        在線節點
    </h3>
    <div class="bg-white shadow-sm ring-1 ring-black ring-opacity-5 sm:rounded-lg">
        <ul role="list" class="divide-y divide-gray-200">
            {% for node in online_nodes %}
            <li class="px-6 py-4 hover:bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center">
                            <i class="fas fa-circle text-green-500 text-xs mr-3"></i>
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ node.node_id }}</p>
                                <p class="text-sm text-gray-500">
                                    版本: {{ node.version if node.version else 'N/A' }} |
                                    最後心跳: {{ node.last_heartbeat.strftime('%H:%M:%S') if node.last_heartbeat else 'N/A' }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="ml-4 flex items-center gap-6">
                        <div class="text-center">
                            <p class="text-xs text-gray-500">目前任務</p>
                            <p class="text-sm font-semibold text-gray-900">
                                {{ node.current_tasks }} / {{ node.max_concurrent_tasks }}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <a href="{{ url_for('views.node_detail', node_id=node.node_id) }}"
                               class="text-indigo-600 hover:text-indigo-900">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if current_user.is_admin() %}
                            <form method="POST" action="{{ url_for('views.node_delete', node_id=node.node_id) }}"
                                  class="inline"
                                  onsubmit="return confirm('確定要註銷此節點嗎？');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!-- 能力標籤 -->
                {% if node.capabilities %}
                <div class="mt-2 ml-6 flex flex-wrap gap-2">
                    {% for capability in node.capabilities %}
                    <span class="inline-flex items-center rounded-md bg-blue-50 px-2 py-1 text-xs font-medium text-blue-700 ring-1 ring-inset ring-blue-700/10">
                        {{ capability }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endif %}

<!-- 離線節點 -->
{% if offline_nodes %}
<div class="mt-8">
    <h3 class="text-lg font-medium text-gray-900 mb-4">
        <i class="fas fa-circle text-red-500 mr-2"></i>
        離線節點
    </h3>
    <div class="bg-white shadow-sm ring-1 ring-black ring-opacity-5 sm:rounded-lg">
        <ul role="list" class="divide-y divide-gray-200">
            {% for node in offline_nodes %}
            <li class="px-6 py-4 hover:bg-gray-50 opacity-60">
                <div class="flex items-center justify-between">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center">
                            <i class="fas fa-circle text-red-500 text-xs mr-3"></i>
                            <div>
                                <p class="text-sm font-medium text-gray-900">{{ node.node_id }}</p>
                                <p class="text-sm text-gray-500">
                                    版本: {{ node.version if node.version else 'N/A' }} |
                                    最後心跳: {{ node.last_heartbeat.strftime('%Y-%m-%d %H:%M:%S') if node.last_heartbeat else 'N/A' }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="ml-4 flex gap-2">
                        <a href="{{ url_for('views.node_detail', node_id=node.node_id) }}"
                           class="text-indigo-600 hover:text-indigo-900">
                            <i class="fas fa-eye"></i>
                        </a>
                        {% if current_user.is_admin() %}
                        <form method="POST" action="{{ url_for('views.node_delete', node_id=node.node_id) }}"
                              class="inline"
                              onsubmit="return confirm('確定要刪除此節點嗎？');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endif %}

{% if not online_nodes and not offline_nodes %}
<div class="mt-8 text-center py-12">
    <i class="fas fa-server text-gray-300 text-6xl mb-4"></i>
    <p class="text-gray-500">暫無註冊節點</p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// 節點列表實時更新
document.addEventListener('DOMContentLoaded', function() {
    // 訂閱節點房間
    wsClient.subscribe('nodes');

    // 監聽節點註冊事件
    wsClient.on('node.registered', function(data) {
        console.log('[節點列表] 節點註冊:', data);
        // 重新載入頁面以顯示新節點
        location.reload();
    });

    // 監聽節點心跳事件
    wsClient.on('node.heartbeat', function(data) {
        console.log('[節點列表] 節點心跳:', data);
        updateNodeInfo(data);
    });

    // 監聽節點上線事件
    wsClient.on('node.online', function(data) {
        console.log('[節點列表] 節點上線:', data);
        // 重新載入頁面以更新節點狀態
        location.reload();
    });

    // 監聽節點離線事件
    wsClient.on('node.offline', function(data) {
        console.log('[節點列表] 節點離線:', data);
        // 重新載入頁面以更新節點狀態
        location.reload();
    });

    // 監聽統計數據更新事件
    wsClient.on('stats.updated', function(data) {
        console.log('[節點列表] 統計更新:', data);
        updateStats(data);
    });

    /**
     * 更新節點信息（心跳數據）
     */
    function updateNodeInfo(data) {
        const nodeId = data.node_id;
        const nodeElements = document.querySelectorAll(`li`);

        nodeElements.forEach(function(nodeEl) {
            const nodeIdEl = nodeEl.querySelector('.text-sm.font-medium.text-gray-900');
            if (nodeIdEl && nodeIdEl.textContent.trim() === nodeId) {
                // 更新當前任務數
                const tasksEl = nodeEl.querySelector('.text-sm.font-semibold.text-gray-900');
                if (tasksEl && data.current_tasks !== undefined) {
                    tasksEl.textContent = `${data.current_tasks} / ${data.max_concurrent_tasks || 1}`;
                }

                // 更新最後心跳時間
                const heartbeatEl = nodeEl.querySelector('.text-sm.text-gray-500');
                if (heartbeatEl && data.timestamp) {
                    const time = new Date(data.timestamp).toLocaleTimeString('zh-TW', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    const versionText = heartbeatEl.textContent.split('|')[0].trim();
                    heartbeatEl.textContent = `${versionText} | 最後心跳: ${time}`;
                }

                // 添加閃爍動畫效果
                nodeEl.classList.add('bg-green-50');
                setTimeout(function() {
                    nodeEl.classList.remove('bg-green-50');
                }, 1000);
            }
        });
    }

    /**
     * 更新統計數據
     */
    function updateStats(data) {
        // 更新總節點數
        const totalEl = document.querySelector('.text-3xl.font-semibold.text-gray-900');
        if (totalEl && data.total_nodes !== undefined) {
            animateNumber(totalEl, parseInt(totalEl.textContent) || 0, data.total_nodes);
        }

        // 更新在線節點數
        const onlineEl = document.querySelector('.text-3xl.font-semibold.text-green-600');
        if (onlineEl && data.online_nodes !== undefined) {
            animateNumber(onlineEl, parseInt(onlineEl.textContent) || 0, data.online_nodes);
        }

        // 更新離線節點數
        const offlineEl = document.querySelector('.text-3xl.font-semibold.text-red-600');
        if (offlineEl && data.offline_nodes !== undefined) {
            animateNumber(offlineEl, parseInt(offlineEl.textContent) || 0, data.offline_nodes);
        }
    }

    /**
     * 數字動畫效果
     */
    function animateNumber(element, from, to) {
        if (from === to) return;

        const duration = 500; // 動畫持續時間（毫秒）
        const steps = 20;
        const stepValue = (to - from) / steps;
        const stepDuration = duration / steps;
        let currentStep = 0;

        const interval = setInterval(function() {
            currentStep++;
            const value = Math.round(from + (stepValue * currentStep));
            element.textContent = value;

            if (currentStep >= steps) {
                clearInterval(interval);
                element.textContent = to;
            }
        }, stepDuration);
    }
});
</script>
{% endblock %}
