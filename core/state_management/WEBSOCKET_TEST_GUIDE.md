# WebSocket 實時推送功能測試指南

## 📋 測試概述

本文檔提供完整的 WebSocket 實時推送功能測試流程，幫助您驗證從輪詢方案遷移到 WebSocket 的所有變更。

---

## 🚀 一、環境準備

### 1.1 安裝依賴

```bash
cd C:\Users\sixsn\PycharmProjects\CPC_server_collectorSYS\core\state_management
pip install -r requirements.txt
```

**新增的依賴：**
- `Flask-SocketIO==5.3.6`
- `python-socketio==5.11.0`
- `eventlet==0.33.3`

### 1.2 確認配置

檢查 `config.py` 中的 WebSocket 配置：

```python
WEBSOCKET_ENABLED = True
WEBSOCKET_PING_TIMEOUT = 60
WEBSOCKET_PING_INTERVAL = 25
WEBSOCKET_ASYNC_MODE = 'eventlet'
```

### 1.3 啟動服務

```bash
# 方式一：使用 Python 直接啟動（推薦用於測試）
python app.py

# 方式二：使用 eventlet WSGI 服務器
eventlet-wsgi app:app

# 服務將啟動在 http://localhost:8000
```

**⚠️ 重要：** 確保使用 `socketio.run()` 而不是 `app.run()`，否則 WebSocket 不會工作。

---

## 🧪 二、基礎功能測試

### 2.1 WebSocket 連接測試

1. **打開瀏覽器**
   - 訪問：http://localhost:8000
   - 使用管理員帳號登入

2. **檢查 WebSocket 連接狀態**
   - 查看導航欄右上角的 **WebSocket 狀態指示器**
   - 預期：顯示 **綠色「已連接」** 狀態

3. **檢查瀏覽器控制台**
   ```
   開啟開發者工具 (F12) → Console
   ```

   預期看到以下日誌：
   ```
   [WebSocket] 初始化連接...
   [WebSocket] 連接成功
   [WebSocket] 連接已建立, Client ID: xxxxx
   ```

4. **檢查網路連接**
   ```
   開啟開發者工具 → Network → WS (WebSocket)
   ```

   應該看到一個 WebSocket 連接到：`ws://localhost:8000/socket.io/`

### 2.2 房間訂閱測試

在不同頁面檢查自動訂閱的房間：

| 頁面 | 訂閱的房間 | 控制台日誌 |
|------|-----------|-----------|
| 儀表板 | `dashboard`, `nodes` | `[WebSocket] 訂閱房間: dashboard` |
| 節點列表 | `nodes` | `[WebSocket] 訂閱房間: nodes` |
| 節點詳情 | `nodes` | `[WebSocket] 訂閱房間: nodes` |

---

## 📡 三、實時推送功能測試

### 3.1 節點註冊實時更新

**測試步驟：**

1. **打開節點列表頁面**
   - 訪問：http://localhost:8000/nodes

2. **註冊一個新節點**（使用 analysis_service_v2）
   - 在另一個終端啟動分析服務：
     ```bash
     cd a_sub_system/analysis_service_v2
     python analysis_main.py
     ```

3. **觀察實時更新**
   - **預期行為：**
     - 節點列表頁面 **自動重新載入**（無需手動刷新）
     - 控制台顯示：`[節點列表] 節點註冊: {node_id: "xxx", status: "online", ...}`
     - 統計卡片的 **總節點數** 和 **在線節點數** 自動更新

4. **檢查儀表板**
   - 切換到儀表板頁面
   - **預期：** 在線節點卡片顯示數字動畫效果（從舊值平滑過渡到新值）

### 3.2 節點心跳實時更新

**測試步驟：**

1. **打開節點詳情頁面**
   - 訪問：http://localhost:8000/nodes/detail/<node_id>
   - 將 `<node_id>` 替換為實際節點 ID

2. **等待心跳更新**（每 30 秒）
   - **預期行為：**
     - **目前任務數** 顯示數字動畫效果
     - **任務負載率** 進度條平滑更新
     - **最後心跳時間** 自動更新為當前時間
     - 頁面閃爍綠色背景（0.5 秒）
     - 控制台顯示：`[節點詳情] 收到心跳更新: {node_id: "xxx", current_tasks: X, ...}`

3. **檢查節點列表頁面**
   - **預期：**
     - 對應節點的 **目前任務數** 實時更新
     - 行項目閃爍綠色背景（1 秒）

4. **檢查儀表板**
   - **預期：**
     - 在線節點列表中的 **任務數** 實時更新
     - 節點項目閃爍綠色背景（0.8 秒）

### 3.3 節點離線實時更新

**測試步驟：**

1. **打開節點列表頁面**

2. **停止一個運行中的節點**
   - 在分析服務終端按 `Ctrl+C`
   - 或直接關閉分析服務進程

3. **等待 NodeMonitor 檢測到離線**（最多 30 秒）
   - **預期行為：**
     - 節點列表頁面 **自動重新載入**
     - 節點從「在線」區塊移動到「離線」區塊
     - 統計卡片的 **在線節點數** 減少，**離線節點數** 增加
     - 控制台顯示：`[節點列表] 節點離線: {node_id: "xxx", ...}`

4. **檢查儀表板**
   - **預期：** 在線節點數自動減少（帶動畫效果）

### 3.4 節點重新上線實時更新

**測試步驟：**

1. **重新啟動之前停止的節點**
   ```bash
   python analysis_main.py
   ```

2. **觀察實時更新**
   - **預期行為：**
     - 節點列表頁面 **自動重新載入**
     - 節點從「離線」區塊移動到「在線」區塊
     - 統計數字自動更新
     - 控制台顯示：`[節點列表] 節點上線: {node_id: "xxx", ...}`

### 3.5 統計數據實時更新

**測試步驟：**

1. **打開儀表板**

2. **觀察統計數據**
   - NodeMonitor 每 30 秒會推送一次統計更新
   - **預期行為：**
     - 在線節點數卡片顯示 **藍色光環閃爍**（1 秒）
     - 數字以 **動畫效果** 更新（0.5 秒過渡）
     - 控制台顯示：`[儀表板] 統計更新: {total_nodes: X, online_nodes: Y, offline_nodes: Z, ...}`

### 3.6 任務創建實時推送（可選測試）

**測試步驟：**

1. **確保有啟用的路由規則**
   - 訪問：http://localhost:8000/routing

2. **向 MongoDB 插入新記錄**
   - 使用 `debug_tools` 或手動插入測試數據
   - 確保記錄符合路由規則的條件

3. **觀察實時推送**
   - TaskScheduler 會檢測到新記錄並創建任務
   - **預期行為：**
     - 控制台顯示：`推送任務創建事件: {task_id: "xxx", rule_id: "xxx", ...}`
     - 如果有打開路由規則詳情頁面，應該看到任務統計更新

---

## 🔍 四、進階測試

### 4.1 連接穩定性測試

**測試場景：模擬網路斷線重連**

1. **打開瀏覽器開發者工具**
   - Network → Throttling → Offline

2. **觀察狀態指示器**
   - **預期：** 變為 **黃色「重連中...」** 狀態
   - 控制台顯示：`[WebSocket] 嘗試重連 (X/5)...`

3. **恢復網路**
   - Throttling → Online

4. **觀察重連**
   - **預期：**
     - 狀態指示器變回 **綠色「已連接」**
     - 控制台顯示：`[WebSocket] 重連成功 (嘗試次數: X)`
     - 自動重新訂閱所有房間

### 4.2 多頁面同步測試

**測試步驟：**

1. **打開兩個瀏覽器視窗（或分頁）**
   - 視窗 A：節點列表頁面
   - 視窗 B：儀表板頁面

2. **註冊/註銷節點，或等待心跳**

3. **觀察同步更新**
   - **預期：** 兩個頁面的數據 **同時自動更新**，無需手動刷新

### 4.3 性能測試

**測試場景：多節點並發心跳**

1. **啟動多個分析服務實例**（3-5 個）

2. **觀察頁面性能**
   - **預期：**
     - 頁面響應流暢，無卡頓
     - 心跳更新平滑，無閃爍
     - 瀏覽器 CPU/記憶體使用正常

3. **檢查後端日誌**
   ```bash
   tail -f logs/state_management.log
   ```
   - 確認沒有錯誤或警告

---

## 🐛 五、故障排除

### 5.1 WebSocket 無法連接

**症狀：** 狀態指示器顯示「連接失敗」或「已斷開」

**可能原因與解決方案：**

1. **服務未正確啟動**
   - 檢查是否使用 `socketio.run()` 而非 `app.run()`
   - 查看終端日誌是否有 `WebSocket 服務已初始化` 訊息

2. **eventlet 未安裝**
   ```bash
   pip install eventlet==0.33.3
   ```

3. **防火牆阻擋**
   - 確認 8000 埠沒有被防火牆阻擋

4. **瀏覽器不支援 WebSocket**
   - 使用現代瀏覽器（Chrome、Firefox、Edge）

### 5.2 事件未推送

**症狀：** 節點心跳或狀態變化沒有實時更新

**排查步驟：**

1. **檢查瀏覽器控制台**
   - 是否有 JavaScript 錯誤？
   - 是否看到事件日誌？（例如：`[節點列表] 節點心跳: {...}`）

2. **檢查房間訂閱**
   - 確認頁面已訂閱正確的房間
   - 控制台應該有：`[WebSocket] 已訂閱房間: nodes`

3. **檢查後端推送**
   - 查看後端日誌：
     ```bash
     grep "推送.*事件" logs/state_management.log
     ```
   - 應該看到類似：`推送節點心跳事件: node_id_xxx`

4. **檢查 WebSocketManager**
   - 確認 `websocket_manager.socketio` 不為 None
   - 檢查是否有異常日誌

### 5.3 頁面頻繁重新載入

**症狀：** 頁面不停自動刷新

**可能原因：**

1. **節點頻繁註冊/註銷**
   - 檢查分析服務是否穩定運行
   - 查看是否有節點不斷重連

2. **事件處理邏輯錯誤**
   - 某些事件觸發了 `location.reload()`
   - 檢查頁面 JavaScript 邏輯

### 5.4 動畫效果不流暢

**症狀：** 數字更新沒有動畫，或閃爍太快

**解決方案：**

1. **檢查 CSS 類別**
   - 確認 `bg-green-50` 等類別在 Tailwind CSS 中存在

2. **調整動畫參數**
   - 編輯 `animateNumber` 函數中的 `duration` 和 `steps` 參數

3. **瀏覽器性能**
   - 關閉不必要的瀏覽器擴充套件
   - 確保電腦性能足夠

---

## ✅ 六、測試清單

使用此清單確認所有功能正常：

### 基礎功能
- [ ] WebSocket 成功連接（狀態指示器為綠色）
- [ ] 瀏覽器控制台顯示正確的連接日誌
- [ ] 各頁面自動訂閱正確的房間

### 節點管理
- [ ] 節點註冊時，節點列表自動重新載入
- [ ] 節點心跳時，節點詳情頁面實時更新任務數
- [ ] 節點心跳時，節點列表頁面實時更新任務數
- [ ] 節點離線時，頁面自動更新狀態
- [ ] 節點重新上線時，頁面自動更新狀態

### 統計數據
- [ ] 儀表板每 30 秒自動更新統計數據
- [ ] 統計數字更新時有平滑動畫效果
- [ ] 節點列表頁面統計卡片實時更新

### 視覺效果
- [ ] 心跳更新時，節點項目閃爍綠色背景
- [ ] 統計更新時，卡片顯示藍色光環
- [ ] 數字變化有動畫過渡效果

### 穩定性
- [ ] 網路斷線後能自動重連
- [ ] 重連後自動重新訂閱房間
- [ ] 多頁面數據保持同步
- [ ] 多節點並發時性能良好

### 任務推送（可選）
- [ ] 新任務創建時推送事件
- [ ] 路由規則詳情頁面接收任務更新

---

## 📊 七、性能基準

### 預期性能指標

| 指標 | 預期值 | 說明 |
|------|--------|------|
| WebSocket 連接時間 | < 500ms | 頁面載入到連接建立 |
| 心跳推送延遲 | < 100ms | 心跳發送到前端接收 |
| 頁面更新延遲 | < 200ms | 事件接收到 DOM 更新 |
| 動畫流暢度 | 60 FPS | 數字動畫和背景閃爍 |
| 並發連接數 | 100+ | 同時連接的客戶端數量 |
| 記憶體增長 | < 50MB/hr | 前端記憶體洩漏檢查 |

### 性能監控工具

1. **瀏覽器開發者工具 → Performance**
   - 記錄頁面性能
   - 檢查動畫幀率
   - 分析記憶體使用

2. **Network 面板**
   - 監控 WebSocket 消息大小和頻率
   - 檢查延遲時間

3. **Console 面板**
   - 查看事件日誌
   - 測量事件處理時間

---

## 📝 八、測試報告模板

完成測試後，請填寫以下報告：

```markdown
## WebSocket 功能測試報告

### 測試環境
- 測試日期：YYYY-MM-DD
- 作業系統：Windows/Linux/macOS
- Python 版本：X.X.X
- 瀏覽器：Chrome/Firefox/Edge X.X.X
- 節點數量：X 個

### 測試結果
- [ ] 所有測試項目通過
- [ ] 部分測試項目失敗（請說明）
- [ ] 發現新問題（請詳述）

### 失敗項目詳情
1. 測試項目：
   - 預期行為：
   - 實際行為：
   - 錯誤訊息：
   - 重現步驟：

### 性能數據
- WebSocket 連接時間：XXms
- 心跳推送延遲：XXms
- 頁面更新延遲：XXms
- 並發連接數：XX 個

### 其他備註
（請補充任何額外的觀察或建議）
```

---

## 🎉 九、成功標準

系統遷移成功的標準：

1. ✅ **所有功能測試通過**
   - WebSocket 連接穩定
   - 實時推送無延遲
   - 頁面更新正確

2. ✅ **性能符合預期**
   - 延遲 < 200ms
   - 無記憶體洩漏
   - 並發處理流暢

3. ✅ **用戶體驗良好**
   - 動畫效果流暢
   - 無卡頓或閃爍
   - 視覺回饋明確

4. ✅ **穩定性可靠**
   - 斷線能自動重連
   - 無異常錯誤
   - 長時間運行穩定

---

## 📚 十、相關文檔

- **WebSocket 事件列表**：參見 `services/websocket_manager.py` 中的事件定義
- **前端客戶端 API**：參見 `static/js/websocket_client.js` 的註釋
- **配置說明**：參見 `config.py` 中的 WebSocket 配置項
- **架構設計**：參見專案根目錄的 `WEBSOCKET_MIGRATION_REPORT.md`（本次變更總結）

---

## 🆘 支援

如果測試過程中遇到問題：

1. **查看日誌**
   ```bash
   tail -f logs/state_management.log
   ```

2. **檢查瀏覽器控制台**
   - F12 → Console
   - 查找紅色錯誤訊息

3. **參考故障排除章節**
   - 第五章詳細說明常見問題

4. **重啟服務**
   ```bash
   # 停止服務
   Ctrl+C

   # 清除快取
   rm -rf __pycache__ logs/*

   # 重新啟動
   python app.py
   ```

---

**測試愉快！** 🚀

如有問題，請查閱相關日誌或聯繫開發團隊。
