{% extends "base.html" %}

{% block title %}音頻錄製管理儀表板{% endblock %}

{% block page_title %}音頻錄製管理系統{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<style>
    .flash {
        animation: flash 1s ease-in-out;
    }

    @keyframes flash {
        0% {
            background-color: #fef3c7;
        }
        100% {
            background-color: transparent;
        }
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .status-pending {
        background-color: #FEF3C7;
        color: #92400E;
    }

    .status-processing {
        background-color: #DBEAFE;
        color: #1E40AF;
    }

    .status-completed {
        background-color: #D1FAE5;
        color: #065F46;
    }

    .status-error {
        background-color: #FEE2E2;
        color: #991B1B;
    }

    .prediction-normal {
        color: #059669;
        font-weight: 600;
    }

    .prediction-abnormal {
        color: #DC2626;
        font-weight: 600;
    }

    .prediction-uncertain {
        color: #F59E0B;
        font-weight: 600;
    }

    .pagination-btn {
        min-width: 2.5rem;
        height: 2.5rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .pagination-btn.active {
        background-color: #4F46E5;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="w-full px-4 lg:px-6 py-6">
    <!-- 上方區塊：已連接的設備 (3/4) 與 網路上傳 (1/4) -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
        <!-- 連接的設備 (佔3格) -->
        <div class="lg:col-span-3 bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="px-4 lg:px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg lg:text-xl font-semibold text-gray-800 flex items-center">
                    <svg class="w-5 h-5 text-indigo-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    已連接的設備列表
                </h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full" id="devicesTable">
                    <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            設備識別碼
                        </th>
                        <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            設備名稱
                        </th>
                        <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            連接狀態
                        </th>
                        <th class="px-3 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            操作選項
                        </th>
                    </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 網路上傳區塊 (佔1格) -->
        <div class="lg:col-span-1 bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="px-4 lg:px-6 py-4 border-b border-gray-200">
                <h2 class="text-base lg:text-lg font-semibold text-gray-800 flex items-center">
                    <svg class="w-5 h-5 text-indigo-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    網路上傳音檔
                </h2>
            </div>
            <div class="p-4 lg:p-6">
                <form id="uploadForm" enctype="multipart/form-data" class="space-y-4">
                    <div class="flex items-center justify-center w-full">
                        <label for="fileInput"
                               class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                <svg class="w-8 h-8 mb-2 text-gray-400" fill="none" stroke="currentColor"
                                     viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                          d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                <p class="mb-1 text-xs text-gray-500 text-center"><span
                                        class="font-semibold">點擊選擇</span></p>
                                <p class="text-xs text-gray-400">或拖曳檔案</p>
                            </div>
                            <input id="fileInput" type="file" accept="audio/*" class="hidden"/>
                        </label>
                    </div>
                    <div id="fileInfo" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p class="text-xs text-gray-700 truncate"><span class="font-semibold">檔案：</span> <span
                                id="fileName"></span></p>
                        <p class="text-xs text-gray-700"><span class="font-semibold">大小：</span> <span
                                id="fileSize"></span></p>
                    </div>
                    <div id="uploadBtnContainer" class="hidden text-center">
                        <button type="submit"
                                class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium"
                                id="uploadBtn">
                            上傳音檔
                        </button>
                    </div>
                    <div id="uploadProgress" class="hidden">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div id="progressBar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="text-xs text-gray-600 text-center mt-2" id="progressText">上傳中...</p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 錄音列表 -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200">
        <div class="px-4 lg:px-6 py-4 border-b border-gray-200">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <h2 class="text-lg lg:text-xl font-semibold text-gray-800 flex items-center">
                    <svg class="w-5 h-5 text-indigo-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                    錄音檔案管理
                    <span class="ml-2 text-sm font-normal text-gray-500">
                        (共 {{ pagination.total_count }} 筆，顯示第 {{ pagination.start_index }}-{{ pagination.end_index }} 筆)
                    </span>
                </h2>

                <!-- 排序和分頁控制 -->
                <div class="flex flex-col sm:flex-row gap-2">
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600 whitespace-nowrap">排序：</label>
                        <select id="sortSelect" onchange="changeSortAndPerPage()"
                                class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="time_desc" {% if pagination.sort_by=='time_desc' %}selected{% endif %}>時間 ↓ (新→舊)</option>
                            <option value="time_asc" {% if pagination.sort_by=='time_asc' %}selected{% endif %}>時間 ↑ (舊→新)</option>
                            <option value="name_asc" {% if pagination.sort_by=='name_asc' %}selected{% endif %}>名稱 ↑ (A→Z)</option>
                            <option value="name_desc" {% if pagination.sort_by=='name_desc' %}selected{% endif %}>名稱 ↓ (Z→A)</option>
                            <option value="duration_desc" {% if pagination.sort_by=='duration_desc' %}selected{% endif %}>時長 ↓ (長→短)</option>
                            <option value="duration_asc" {% if pagination.sort_by=='duration_asc' %}selected{% endif %}>時長 ↑ (短→長)</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600 whitespace-nowrap">每頁：</label>
                        <select id="perPageSelect" onchange="changeSortAndPerPage()"
                                class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            <option value="10" {% if pagination.per_page== 10 %}selected{% endif %}>10</option>
                            <option value="50" {% if pagination.per_page== 50 %}selected{% endif %}>50</option>
                            <option value="100" {% if pagination.per_page== 100 %}selected{% endif %}>100</option>
                            <option value="200" {% if pagination.per_page== 200 %}selected{% endif %}>200</option>
                            <option value="1000" {% if pagination.per_page== 1000 %}selected{% endif %}>1000</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full" id="recordingsTable">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-2 lg:px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        #
                    </th>
                    <th class="px-2 lg:px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        UUID
                    </th>
                    <th class="px-2 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        檔案名稱
                    </th>
                    <th class="px-2 lg:px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        時長(秒)
                    </th>
                    <th class="px-2 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        錄製時間
                    </th>
                    <th class="px-2 lg:px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        設備ID
                    </th>
                    <th class="px-2 lg:px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        分析狀態
                    </th>
                    <th class="px-2 lg:px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        分析結果
                    </th>
                    <th class="px-2 lg:px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        操作選項
                    </th>
                </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                </tbody>
            </table>
        </div>

        <!-- 分頁控制 -->
        {% if pagination.total_pages > 1 %}
        <div class="px-4 lg:px-6 py-4 border-t border-gray-200">
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                <div class="text-sm text-gray-600">
                    顯示第 {{ pagination.start_index }}-{{ pagination.end_index }} 筆，共 {{ pagination.total_count }} 筆
                </div>

                <div class="flex items-center gap-1">
                    <!-- 第一頁 -->
                    <a href="?page=1&per_page={{ pagination.per_page }}&sort_by={{ pagination.sort_by }}"
                       class="pagination-btn px-3 py-1 border border-gray-300 rounded-lg text-sm {% if not pagination.has_prev %}opacity-50 cursor-not-allowed{% else %}hover:bg-gray-100{% endif %}"
                       {% if not pagination.has_prev %}onclick="return false;" {% endif %}>
                        «
                    </a>

                    <!-- 上一頁 -->
                    <a href="?page={{ pagination.prev_page }}&per_page={{ pagination.per_page }}&sort_by={{ pagination.sort_by }}"
                       class="pagination-btn px-3 py-1 border border-gray-300 rounded-lg text-sm {% if not pagination.has_prev %}opacity-50 cursor-not-allowed{% else %}hover:bg-gray-100{% endif %}"
                       {% if not pagination.has_prev %}onclick="return false;" {% endif %}>
                        ‹
                    </a>

                    <!-- 頁碼 -->
                    {% set start_page = [1, pagination.page - 2]|max %}
                    {% set end_page = [pagination.total_pages, pagination.page + 2]|min %}

                    {% if start_page > 1 %}
                    <span class="px-2 text-gray-500">...</span>
                    {% endif %}

                    {% for p in range(start_page, end_page + 1) %}
                    <a href="?page={{ p }}&per_page={{ pagination.per_page }}&sort_by={{ pagination.sort_by }}"
                       class="pagination-btn px-3 py-1 border border-gray-300 rounded-lg text-sm hover:bg-gray-100 {% if p == pagination.page %}active{% endif %}">
                        {{ p }}
                    </a>
                    {% endfor %}

                    {% if end_page < pagination.total_pages %}
                    <span class="px-2 text-gray-500">...</span>
                    {% endif %}

                    <!-- 下一頁 -->
                    <a href="?page={{ pagination.next_page }}&per_page={{ pagination.per_page }}&sort_by={{ pagination.sort_by }}"
                       class="pagination-btn px-3 py-1 border border-gray-300 rounded-lg text-sm {% if not pagination.has_next %}opacity-50 cursor-not-allowed{% else %}hover:bg-gray-100{% endif %}"
                       {% if not pagination.has_next %}onclick="return false;" {% endif %}>
                        ›
                    </a>

                    <!-- 最後一頁 -->
                    <a href="?page={{ pagination.total_pages }}&per_page={{ pagination.per_page }}&sort_by={{ pagination.sort_by }}"
                       class="pagination-btn px-3 py-1 border border-gray-300 rounded-lg text-sm {% if not pagination.has_next %}opacity-50 cursor-not-allowed{% else %}hover:bg-gray-100{% endif %}"
                       {% if not pagination.has_next %}onclick="return false;" {% endif %}>
                        »
                    </a>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 排序和分頁控制
    function changeSortAndPerPage() {
        const sort = document.getElementById('sortSelect').value;
        const perPage = document.getElementById('perPageSelect').value;
        window.location.href = `?page=1&per_page=${perPage}&sort_by=${sort}`;
    }

    // 網路上傳相關函數
    let selectedFile = null;

    // 檔案選擇事件監聽器
    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.getElementById('fileInput');
        if (fileInput) {
            fileInput.addEventListener('change', function (event) {
                selectedFile = event.target.files[0];
                console.log('File selected:', selectedFile);
                if (selectedFile) {
                    document.getElementById('fileName').textContent = selectedFile.name;
                    document.getElementById('fileSize').textContent = formatFileSize(selectedFile.size);
                    document.getElementById('fileInfo').classList.remove('hidden');
                    const btnContainer = document.getElementById('uploadBtnContainer');
                    console.log('Button container:', btnContainer);
                    btnContainer.classList.remove('hidden');
                    console.log('Button container classes:', btnContainer.className);
                }
            });
        }
    });

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    document.getElementById('uploadForm').addEventListener('submit', async function (e) {
        e.preventDefault();

        if (!selectedFile) {
            alert('請先選擇檔案');
            return;
        }

        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('device_id', 'WEB_UPLOAD');

        // 顯示進度條，隱藏按鈕
        document.getElementById('uploadProgress').classList.remove('hidden');
        document.getElementById('uploadBtnContainer').classList.add('hidden');

        try {
            const response = await fetch('/upload_recording', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                alert('上傳成功！');
                // 重置表單
                document.getElementById('uploadForm').reset();
                document.getElementById('fileInfo').classList.add('hidden');
                document.getElementById('uploadProgress').classList.add('hidden');
                selectedFile = null;
                // 重新載入頁面以顯示新上傳的檔案
                window.location.reload();
            } else {
                alert('上傳失敗: ' + result.error);
                document.getElementById('uploadBtnContainer').classList.remove('hidden');
            }
        } catch (error) {
            console.error('上傳錯誤:', error);
            alert('上傳過程中發生錯誤');
            document.getElementById('uploadBtnContainer').classList.remove('hidden');
        } finally {
            document.getElementById('uploadProgress').classList.add('hidden');
        }
    });

    // 拖曳上傳支援
    const dropZone = document.querySelector('label[for="fileInput"]');

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-indigo-500', 'bg-indigo-50');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');

        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const fileInput = document.getElementById('fileInput');
            fileInput.files = files;

            // 手動觸發檔案選擇邏輯
            selectedFile = files[0];
            if (selectedFile) {
                document.getElementById('fileName').textContent = selectedFile.name;
                document.getElementById('fileSize').textContent = formatFileSize(selectedFile.size);
                document.getElementById('fileInfo').classList.remove('hidden');
                document.getElementById('uploadBtnContainer').classList.remove('hidden');
            }
        }
    });

    var socket = io();

    socket.on('connect', function () {
        console.log('Connected to server');
    });

    socket.on('disconnect', function () {
        console.log('Disconnected from server');
    });

    socket.on('update_devices', function (data) {
        updateDevicesTable(data.devices);
    });

    socket.on('new_recording', function (data) {
        // 新上傳時重新載入頁面以保持分頁正確
        window.location.reload();
    });

    socket.on('recording_deleted', function (data) {
        removeRecordingFromTable(data.id);
    });

    function updateDevicesTable(devices) {
        var tbody = document.querySelector('#devicesTable tbody');
        tbody.innerHTML = '';
        devices.forEach(function (device) {
            var row = tbody.insertRow();
            row.innerHTML = `
            <td class="px-3 lg:px-4 py-2 text-sm font-mono">${device.id}</td>
            <td class="px-3 lg:px-4 py-2 text-sm">
                <span id="device-name-${device.id}" class="font-medium">${device.name}</span>
                <button onclick="editDeviceName('${device.id}')" class="ml-2 text-blue-600 hover:text-blue-800 text-xs">編輯</button>
            </td>
            <td class="px-3 lg:px-4 py-2">
                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${device.status === 'IDLE' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                    ${device.status}
                </span>
            </td>
            <td class="px-3 lg:px-4 py-2">
                <div class="flex items-center gap-2">
                    <div class="flex items-center gap-1">
                        <label for="duration-${device.id}" class="text-xs text-gray-600 whitespace-nowrap">時長(秒):</label>
                        <input type="number" id="duration-${device.id}" value="10" min="1" class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <button onclick="startRecording('${device.id}')"
                            class="bg-indigo-600 text-white px-3 py-1 rounded-md hover:bg-indigo-700 text-sm transition-colors whitespace-nowrap">
                        開始錄音
                    </button>
                </div>
            </td>
        `;
        });
    }

    function getAnalysisStatusBadge(status, currentStep) {
        const statusMap = {
            'pending': {text: '等待處理', class: 'status-pending'},
            'processing': {text: `處理中 (Step ${currentStep}/4)`, class: 'status-processing'},
            'sliced': {text: '切割完成', class: 'status-processing'},
            'features_extracted': {text: '特徵提取完成', class: 'status-processing'},
            'completed': {text: '✓ 分析完成', class: 'status-completed'},
            'error': {text: '✗ 錯誤', class: 'status-error'}
        };

        const badge = statusMap[status] || {text: '未知', class: 'status-pending'};
        return `<span class="status-badge ${badge.class}">${badge.text}</span>`;
    }

    function getAnalysisResult(summary) {
        if (!summary || !summary.final_prediction) {
            return '<span class="text-gray-400 text-xs">-</span>';
        }

        const predictionMap = {
            'normal': {text: '✓ 正常', class: 'prediction-normal'},
            'abnormal': {text: '✗ 異常', class: 'prediction-abnormal'},
            'uncertain': {text: '? 不確定', class: 'prediction-uncertain'}
        };

        const prediction = predictionMap[summary.final_prediction] || {text: summary.final_prediction, class: ''};
        const confidence = summary.average_confidence ? ` (${(summary.average_confidence * 100).toFixed(1)}%)` : '';

        return `<span class="${prediction.class}">${prediction.text}${confidence}</span>`;
    }

    function addRecordingToTable(recording, index) {
        if (recording.id === undefined) {
            return;
        }

        var tbody = document.querySelector('#recordingsTable tbody');
        var newRow = tbody.insertRow();

        // 格式化時間戳（處理 ISO 格式）
        var timestamp = recording.timestamp;
        try {
            var date = new Date(timestamp);
            timestamp = date.toLocaleString('zh-TW', {timeZone: 'Asia/Taipei'});
        } catch (e) {
            // 如果解析失敗，保持原樣
        }

        // 處理 duration（可能是字串或數字）
        var duration = parseFloat(recording.duration);
        if (isNaN(duration)) {
            duration = 0;
        }

        // 截斷 UUID 顯示（顯示前8字元）
        var shortId = recording.id.substring(0, 8);

        // 分析狀態
        const analysisStatus = recording.analysis_status || 'pending';
        const currentStep = recording.current_step || 0;
        const analysisSummary = recording.analysis_summary || {};

        newRow.innerHTML = `
        <td class="px-2 lg:px-3 py-2 text-sm text-gray-600">${recording.display_index}</td>
        <td class="px-2 lg:px-3 py-2 text-sm font-mono" title="${recording.id}">${shortId}...</td>
        <td class="px-2 lg:px-4 py-2 text-sm font-medium break-all">${recording.filename}</td>
        <td class="px-2 lg:px-3 py-2 text-sm">${duration.toFixed(2)}</td>
        <td class="px-2 lg:px-4 py-2 text-xs text-gray-600">${timestamp}</td>
        <td class="px-2 lg:px-3 py-2 text-sm font-mono">${recording.device_id}</td>
        <td class="px-2 lg:px-3 py-2 text-sm">
            ${getAnalysisStatusBadge(analysisStatus, currentStep)}
        </td>
        <td class="px-2 lg:px-3 py-2 text-sm">
            ${getAnalysisResult(analysisSummary)}
        </td>
        <td class="px-2 lg:px-4 py-2">
            <div class="flex flex-col sm:flex-row gap-1">
                <button onclick="downloadRecording('${recording.id}')"
                        class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700 transition-colors">
                    下載
                </button>
                <button onclick="window.location.href='/play/${recording.id}'"
                        class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700 transition-colors">
                    詳情
                </button>
                <button onclick="deleteRecording('${recording.id}')"
                        class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 transition-colors">
                    刪除
                </button>
            </div>
        </td>
    `;
    }

    function downloadRecording(id) {
        fetch(`/check_upload/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.upload_complete) {
                        window.location.href = `/download/${id}`;
                    } else {
                        alert('檔案處理中，請稍後再試。');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('發生錯誤，請稍後再試。');
                });
    }

    function removeRecordingFromTable(id) {
        // 刪除後重新載入頁面以保持分頁正確
        window.location.reload();
    }

    function startRecording(deviceId) {
        var durationInput = document.getElementById('duration-' + deviceId);
        var duration = parseFloat(durationInput.value);

        if (!duration || duration <= 0) {
            alert("請輸入有效的錄音時長");
            return;
        }

        socket.emit('start_recording', {device_id: deviceId, duration: duration}, function (response) {
            if (response.error) {
                alert("錄音失敗: " + response.error);
            }
        });
    }

    function deleteRecording(id) {
        if (confirm('確定要刪除這個錄音嗎?')) {
            fetch('/delete/' + id, {method: 'POST'})
                    .then(response => response.json())
                    .then(data => {
                        window.location.reload();  // ← 直接重新載入,不顯示訊息
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
        }
    }


    function editDeviceName(deviceId) {
        var currentName = document.getElementById('device-name-' + deviceId).textContent;
        var newName = prompt("請輸入新的設備名稱:", currentName);
        if (newName && newName !== currentName) {
            socket.emit('update_device_name', {device_id: deviceId, device_name: newName});
        }
    }

    // 初始化設備列表和錄音列表
    updateDevicesTable({{ devices | tojson | safe}});
    {%for recording in recordings %}
        addRecordingToTable({
            display_index: {{ recording.display_index }},
            id: "{{ recording.id }}",
            filename: "{{ recording.filename }}",
            duration: {{ recording.duration }},
            timestamp: "{{ recording.timestamp }}",
            device_id: "{{ recording.device_id }}",
            analysis_status:    "{{ recording.analysis_status }}",
            current_step:    {{ recording.current_step }},
            analysis_summary: {{ recording.analysis_summary | tojson | safe }}
        });
    {% endfor %}
</script>
{% endblock %}