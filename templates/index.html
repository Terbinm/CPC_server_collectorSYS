<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音頻錄製管理</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <h1>音頻錄製管理</h1>
        <div class="card">
            <h2>切換功能</h2>
            <button onclick="window.location.href='/'">音頻錄製管理</button>
            <button onclick="window.location.href='/schedule_management'">調度管理</button>
        </div>

        <div class="card">
            <h2>連接的設備</h2>
            <table id="devicesTable">
                <thead>
                    <tr>
                        <th>設備 ID</th>
                        <th>設備名稱</th>
                        <th>狀態</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="card">
            <h2>錄音列表</h2>
            <table id="recordingsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>檔案名</th>
                        <th>時長 (秒)</th>
                        <th>時間戳</th>
                        <th>設備 ID</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <script>
    var socket = io();

    socket.on('connect', function() {
        console.log('Connected to server');
    });

    socket.on('disconnect', function() {
        console.log('Disconnected from server');
    });

    socket.on('update_devices', function(data) {
        updateDevicesTable(data.devices);
    });

    socket.on('new_recording', function(data) {
        addRecordingToTable(data);
    });

    socket.on('recording_deleted', function(data) {
        removeRecordingFromTable(data.id);
    });

    function updateDevicesTable(devices) {
        var tbody = document.querySelector('#devicesTable tbody');
        tbody.innerHTML = '';
        devices.forEach(function(device) {
            var row = tbody.insertRow();
            row.innerHTML = `
                <td>${device.id}</td>
                <td><span id="device-name-${device.id}">${device.name}</span> <button onclick="editDeviceName('${device.id}')">編輯</button></td>
                <td><span class="status-${device.status}">${device.status}</span></td>
                <td><button onclick="startRecording('${device.id}')">開始錄音</button></td>
            `;
        });
    }

    function addRecordingToTable(recording) {
        // 檢查 recording.id 是否為 undefined
        if (recording.id === undefined) {
            return; // 如果 ID 為 undefined，直接返回，不執行後續操作(又不是跟你聊天，還來偷聽。)
        }

        var tbody = document.querySelector('#recordingsTable tbody');
        var newRow = tbody.insertRow(0);
        // const localTimestamp = new Date(recording.timestamp).toLocaleString();
        newRow.innerHTML = `
            <td>${recording.id}</td>
            <td>${recording.filename}</td>
            <td>${recording.duration}</td>
            <td>${recording.timestamp}</td>
            <td>${recording.device_id}</td>
            <td>
                <button onclick="downloadRecording(${recording.id})">下載</button>
                <button class="btn btn-primary" onclick="window.location.href='/play/${recording.id}'">播放</button>
                <button onclick="deleteRecording(${recording.id})" style="background-color: #e74c3c;">刪除</button>
                <audio id="audio-${recording.id}" style="display:none;"></audio>
            </td>
        `;

        // 添加閃爍效果
        newRow.classList.add('flash');
        setTimeout(() => {
            newRow.classList.remove('flash');
        }, 1000);
    }

    function downloadRecording(id) {
        fetch(`/check_upload/${id}`)
            .then(response => response.json())
            .then(data => {
                if (data.upload_complete) {
                    window.location.href = `/download/${id}`;
                } else {
                    alert('檔案處理中，請稍後再試。');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('發生錯誤，請稍後再試。');
            });
    }


    function removeRecordingFromTable(id) {
        var tbody = document.querySelector('#recordingsTable tbody');
        for (var i = 0; i < tbody.rows.length; i++) {
            if (Number(tbody.rows[i].cells[0].textContent)  === id) {
                tbody.deleteRow(i);
                break;
            }
        }
    }

    function startRecording(deviceId) {
        var duration = prompt("請輸入錄音時長（秒）:", "10");
        if (duration) {
            socket.emit('start_recording', {device_id: deviceId, duration: parseFloat(duration)}, function(response) {
                if (response.error) {
                    alert("錄音失敗: " + response.error);
                } else {
                    alert(response.message);
                }
            });
        }
    }

    function deleteRecording(id) {
        if (confirm('確定要刪除這個錄音嗎？')) {
            fetch('/delete/' + id, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    alert(data.message);
                    removeRecordingFromTable(id);
                })
                .catch((error) => {
                    console.error('Error:', error);
                    // alert('刪除失敗');
                    // window.location.reload();
                });
        }
    }

    function editDeviceName(deviceId) {
        var currentName = document.getElementById('device-name-' + deviceId).textContent;
        var newName = prompt("請輸入新的設備名稱:", currentName);
        if (newName && newName !== currentName) {
            socket.emit('update_device_name', {device_id: deviceId, device_name: newName});
        }
    }

    // 初始化設備列表和錄音列表
    updateDevicesTable({{ devices | tojson | safe }});
    {% for recording in recordings %}
    addRecordingToTable({
        id: {{ recording.id }},
        filename: "{{ recording.filename }}",
        duration: {{ recording.duration }},
        timestamp: "{{ recording.timestamp }}",
        device_id: "{{ recording.device_id }}"
    });
    {% endfor %}
    </script>
</body>
</html>